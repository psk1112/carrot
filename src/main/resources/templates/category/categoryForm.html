<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/adminlayout}">


<th:block layout:fragment="css">
    <style>
        .form-control:focus {
            outline: none !important;
            border-color : #FD6F22;
            box-shadow: 0 0 10px #FD6F22;
        }

        h3 {
            padding-top: 20px;
        }

        .surround {
            display: flex;
            flex-direction: column;
            min-height: 60vh;
        }

        .tableBox {
            flex: 1;
            overflow: auto;
            max-height: calc(60vh - 150px);
            padding: 20px;
        }

        .buttonBox {
            text-align: right;
            padding-top: 10px;
        }
    </style>
</th:block>
<th:block layout:fragment="script">
    <script>
        document.addEventListener("DOMContentLoaded", function() {

            var modifyButtons = document.querySelectorAll(".modify-button");
            var deleteButtons = document.querySelectorAll(".delete-button");


            // 새 카테고리 추가 공통 로직 (Input hidden요소 없애기)
            function handleAddNewCategory(tabId){
                var addNewCategory = document.querySelector(tabId + " .clickable-text");

                addNewCategory.addEventListener("click", function() {
                    var newCategoryInput = document.querySelector(tabId + " .newCate");
                    newCategoryInput.removeAttribute("hidden");
                });
            }


            // 수정 버튼 클릭
            modifyButtons.forEach(function(button) {
                button.addEventListener("click", function(event) {

                    var kindSeq = event.target.getAttribute("data-id");
                    var kindInput = document.getElementById(kindSeq);

                    kindInput.readOnly = false; //해당 input요소 readonly해제

                    kindInput.addEventListener("change", function() {
                        kindInput.dataset.changed = "true";
                    });
                });
            });


            // 삭제 버튼 클릭
            deleteButtons.forEach(function(button) {
                button.addEventListener("click", function(event) {

                    var inputSeq = event.target.getAttribute("data-id");

                    Swal.fire({
                        title: '정말로 삭제하시겠습니까?',
                        text: "카테고리와 관련된 게시물 모두 삭제됩니다. ",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: '삭제',
                        cancelButtonText: '취소'
                    }).then((result) => {
                        if (result.isConfirmed) {

                            // AJAX 요청으로 서버에 데이터 전송
                            fetch("/category/deleteData", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "text/plain;charset=UTF-8"
                                },
                                body: inputSeq
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === "success") {
                                    Swal.fire({
                                        text: '성공적으로 삭제되었습니다.',
                                        icon: 'success',
                                        confirmButtonText: '확인'
                                    }).then(() => {
                                         window.location.reload();
                                    })
                                } else {
                                    Swal.fire(
                                    '게시물 삭제에 실패했습니다.',
                                    'error'
                                    )
                                }
                            })
                            .catch(error => {
                                alert(error.message);
                            })
                            //AJAX END
                        }
                    });
                });
            });


            // 저장 버튼 클릭 공통 로직 함수
            function handleSaveButtonClick(tabId) {

                var saveButton = document.querySelector(tabId + " .save-button");

                saveButton.addEventListener("click", function() {

                    // 탭에 따른 데이터 처리 로직
                    var newCate = document.querySelector(tabId + " .newCate");
                    var changedInputs = document.querySelectorAll(tabId + " .KindName[data-changed='true']");

                    // 값 배열에 담기
                    var inputSeq = [];
                    var inputValue = [];

                    changedInputs.forEach(function(input) {
                        var KindSeq = input.id;
                        var KindValue = input.value;

                        inputSeq.push(KindSeq);
                        inputValue.push(KindValue);
                    });

                    var newCateValue = newCate.value;

                    if (!newCateValue && inputValue.length === 0) {
                        Swal.fire('등록하실 카테고리 이름을 입력해주세요.');
                        return;
                    }

                    if (newCateValue) {
                        inputSeq.push(newCate.id); // 새로운 카테고리인 경우 "faq_newCate" 값을 추가
                        inputValue.push(newCateValue);
                    }

                    // 데이터 객체 생성
                    var data = {
                        inputSeq: inputSeq,
                        inputValue: inputValue
                    };

                    var jsonData = JSON.stringify(data);

                    // AJAX 요청으로 서버에 데이터 전송
                    fetch("/category/saveData", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json;charset=UTF-8"
                        },
                        body: jsonData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            Swal.fire({
                                text: '성공적으로 처리되었습니다.',
                                icon: 'success',
                                confirmButtonText: '확인'
                            }).then(() => {
                                 window.location.reload();
                            })
                        } else {
                            console.log(data)
                            Swal.fire('처리 실패했습니다.');
                        }
                    })
                    .catch(error => {
                        alert(error.message)
                    });
                });
            }


            // tabId
            var tabSelector = [
                "#user-tab-pane",
                "#post-tab-pane",
                "#faq-tab-pane",
                "#question-tab-pane"
            ]

            tabSelector.forEach(function(tabSelector){
                handleAddNewCategory(tabSelector);
                handleSaveButtonClick(tabSelector);
            });

        });
    </script>
</th:block>

<div layout:fragment="content" class="container my-3">
    <h3>카테고리 관리</h3><br>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="user-tab" data-bs-toggle="tab" data-bs-target="#user-tab-pane" type="button" role="tab" aria-controls="user-tab-pane" aria-selected="true">회원 신고</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="post-tab" data-bs-toggle="tab" data-bs-target="#post-tab-pane" type="button" role="tab" aria-controls="post-tab-pane" aria-selected="false">게시물 신고</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="faq-tab" data-bs-toggle="tab" data-bs-target="#faq-tab-pane" type="button" role="tab" aria-controls="faq-tab-pane" aria-selected="false">자주 묻는 질문</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="question-tab" data-bs-toggle="tab" data-bs-target="#question-tab-pane" type="button" role="tab" aria-controls="question-tab-pane" aria-selected="false">문의하기</button>
        </li>
    </ul>
    <br>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="user-tab-pane" role="tabpanel" aria-labelledby="user-tab" tabindex="0">
            <div class="container surround">
                <a href="#" class="clickable-text" id="user">+새카테고리 추가</a><br>
                <div class="tableBox">
                    <table>
                        <tr>
                            <td colspan="3"><input type="text" class="newCate form-control" id="user_newCate" placeholder="카테고리 이름을 입력하세요" hidden="hidden"></td>
                        </tr>
                        <tr th:each="cateList : ${cateListU}">
                            <td><input type="text" class="KindName form-control" th:value="${cateList.userClaimKindName}" th:id="'user_' + ${cateList.userClaimKindSeq}" readonly></td>
                            <td><button type="button" class="modify-button btn btn-outline-warning" th:data-id="'user_' + ${cateList.userClaimKindSeq}">✏️수정️</button></td>
                            <td><button type="button" class="delete-button btn btn-outline-danger" th:data-id="'user_' + ${cateList.userClaimKindSeq}">🗑️삭제</button></td>
                        </tr>
                    </table>
                </div>
                <br>
                <div class="buttonBox">
                    <button type="button" class="save-button btn btn-primary">저장</button>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="post-tab-pane" role="tabpanel" aria-labelledby="post-tab" tabindex="0">
            <div class="container surround">
                <a href="#" class="clickable-text" id="post">+새카테고리 추가</a><br>
                <div class="tableBox">
                    <table>
                        <tr>
                            <td><input type="text" class="newCate form-control" id="post_newCate" placeholder="카테고리 이름을 입력하세요" hidden="hidden"></td>
                        </tr>
                        <tr th:each="cateList : ${cateListP}">
                            <td><input type="text" class="KindName form-control" th:value="${cateList.postClaimKindName}" th:id="'post_' + ${cateList.postClaimKindSeq}" readonly></td>
                            <td><button type="button" class="modify-button btn btn-outline-warning" th:data-id="'post_' + ${cateList.postClaimKindSeq}">✏️수정️</button></td>
                            <td><button type="button" class="delete-button btn btn-outline-danger" th:data-id="'post_' + ${cateList.postClaimKindSeq}">🗑️삭제</button></td>
                        </tr>
                    </table>
                </div>
                <br>
                <div class="buttonBox">
                    <button type="button" class="save-button btn btn-primary">저장</button>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="faq-tab-pane" role="tabpanel" aria-labelledby="faq-tab" tabindex="0">
            <div class="container surround">
                <a href="#" class="clickable-text" id="faq">+새카테고리 추가</a><br>
                <div class="tableBox">
                    <table>
                        <tr>
                            <td><input type="text" class="newCate form-control" id="faq_newCate" placeholder="카테고리 이름을 입력하세요" hidden="hidden"></td>
                        </tr>
                        <tr th:each="cateList : ${cateListF}">
                            <td><input type="text" class="KindName form-control" th:value="${cateList.faqKindName}" th:id="'faq_' + ${cateList.faqKindSeq}" readonly></td>
                            <td><button type="button" class="modify-button btn btn-outline-warning" th:data-id="'faq_' + ${cateList.faqKindSeq}">✏️수정️</button></td>
                            <td><button type="button" class="delete-button btn btn-outline-danger" th:data-id="'faq_' + ${cateList.faqKindSeq}">🗑️삭제</button></td>
                        </tr>
                    </table>
                </div>
                <br>
                <div class="buttonBox">
                    <button type="button" class="save-button btn btn-primary">저장</button>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="question-tab-pane" role="tabpanel" aria-labelledby="question-tab" tabindex="0">
            <div class="container surround">
                <a href="#" class="clickable-text" id="ques">+새카테고리 추가</a><br>
                <div class="tableBox">
                    <table>
                        <tr>
                            <td><input type="text" class="newCate form-control" id="ques_newCate" placeholder="카테고리 이름을 입력하세요" hidden="hidden"></td>
                        </tr>
                        <tr th:each="cateList : ${cateListQ}">
                            <td><input type="text" class="KindName form-control" th:value="${cateList.questionKindName}" th:id="'ques_' + ${cateList.questionKindSeq}" readonly></td>
                            <td><button type="button" class="modify-button btn btn-outline-warning" th:data-id="'ques_' + ${cateList.questionKindSeq}">✏️수정️</button></td>
                            <td><button type="button" class="delete-button btn btn-outline-danger" th:data-id="'ques_' + ${cateList.questionKindSeq}">🗑️삭제</button></td>
                        </tr>
                    </table>
                </div>
                <br>
                <div class="buttonBox">
                    <button type="button" class="save-button btn btn-primary">저장</button>
                </div>
            </div>
        </div>
    </div>
</div>
</html>
