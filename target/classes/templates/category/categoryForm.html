<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/adminlayout}">


<th:block layout:fragment="css">
    <style>
        .form-control:focus {
            outline: none !important;
            border-color : #FD6F22;
            box-shadow: 0 0 10px #FD6F22;
        }

        h3 {
            padding-top: 20px;
        }

        .surround {
            display: flex;
            flex-direction: column;
            min-height: 60vh;
        }

        .tableBox {
            flex: 1;
            overflow: auto;
            max-height: calc(60vh - 150px);
            padding: 20px;
        }

        .buttonBox {
            text-align: right;
            padding-top: 10px;
        }
    </style>
</th:block>
<th:block layout:fragment="script">
    <script>
        document.addEventListener("DOMContentLoaded", function() {

            var modifyButtons = document.querySelectorAll(".modify-button");
            var deleteButtons = document.querySelectorAll(".delete-button");


            // ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ê³µí†µ ë¡œì§ (Input hiddenìš”ì†Œ ì—†ì• ê¸°)
            function handleAddNewCategory(tabId){
                var addNewCategory = document.querySelector(tabId + " .clickable-text");

                addNewCategory.addEventListener("click", function() {
                    var newCategoryInput = document.querySelector(tabId + " .newCate");
                    newCategoryInput.removeAttribute("hidden");
                });
            }


            // ìˆ˜ì • ë²„íŠ¼ í´ë¦­
            modifyButtons.forEach(function(button) {
                button.addEventListener("click", function(event) {

                    var kindSeq = event.target.getAttribute("data-id");
                    var kindInput = document.getElementById(kindSeq);

                    kindInput.readOnly = false; //í•´ë‹¹ inputìš”ì†Œ readonlyí•´ì œ

                    kindInput.addEventListener("change", function() {
                        kindInput.dataset.changed = "true";
                    });
                });
            });


            // ì‚­ì œ ë²„íŠ¼ í´ë¦­
            deleteButtons.forEach(function(button) {
                button.addEventListener("click", function(event) {

                    var inputSeq = event.target.getAttribute("data-id");

                    Swal.fire({
                        title: 'ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                        text: "ì¹´í…Œê³ ë¦¬ì™€ ê´€ë ¨ëœ ê²Œì‹œë¬¼ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'ì‚­ì œ',
                        cancelButtonText: 'ì·¨ì†Œ'
                    }).then((result) => {
                        if (result.isConfirmed) {

                            // AJAX ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ë°ì´í„° ì „ì†¡
                            fetch("/category/deleteData", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "text/plain;charset=UTF-8"
                                },
                                body: inputSeq
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === "success") {
                                    Swal.fire({
                                        text: 'ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
                                        icon: 'success',
                                        confirmButtonText: 'í™•ì¸'
                                    }).then(() => {
                                         window.location.reload();
                                    })
                                } else {
                                    Swal.fire(
                                    'ê²Œì‹œë¬¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
                                    'error'
                                    )
                                }
                            })
                            .catch(error => {
                                alert(error.message);
                            })
                            //AJAX END
                        }
                    });
                });
            });


            // ì €ì¥ ë²„íŠ¼ í´ë¦­ ê³µí†µ ë¡œì§ í•¨ìˆ˜
            function handleSaveButtonClick(tabId) {

                var saveButton = document.querySelector(tabId + " .save-button");

                saveButton.addEventListener("click", function() {

                    // íƒ­ì— ë”°ë¥¸ ë°ì´í„° ì²˜ë¦¬ ë¡œì§
                    var newCate = document.querySelector(tabId + " .newCate");
                    var changedInputs = document.querySelectorAll(tabId + " .KindName[data-changed='true']");

                    // ê°’ ë°°ì—´ì— ë‹´ê¸°
                    var inputSeq = [];
                    var inputValue = [];

                    changedInputs.forEach(function(input) {
                        var KindSeq = input.id;
                        var KindValue = input.value;

                        inputSeq.push(KindSeq);
                        inputValue.push(KindValue);
                    });

                    var newCateValue = newCate.value;

                    if (!newCateValue && inputValue.length === 0) {
                        Swal.fire('ë“±ë¡í•˜ì‹¤ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    if (newCateValue) {
                        inputSeq.push(newCate.id); // ìƒˆë¡œìš´ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° "faq_newCate" ê°’ì„ ì¶”ê°€
                        inputValue.push(newCateValue);
                    }

                    // ë°ì´í„° ê°ì²´ ìƒì„±
                    var data = {
                        inputSeq: inputSeq,
                        inputValue: inputValue
                    };

                    var jsonData = JSON.stringify(data);

                    // AJAX ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ë°ì´í„° ì „ì†¡
                    fetch("/category/saveData", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json;charset=UTF-8"
                        },
                        body: jsonData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            Swal.fire({
                                text: 'ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.',
                                icon: 'success',
                                confirmButtonText: 'í™•ì¸'
                            }).then(() => {
                                 window.location.reload();
                            })
                        } else {
                            console.log(data)
                            Swal.fire('ì²˜ë¦¬ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    })
                    .catch(error => {
                        alert(error.message)
                    });
                });
            }


            // tabId
            var tabSelector = [
                "#user-tab-pane",
                "#post-tab-pane",
                "#faq-tab-pane",
                "#question-tab-pane"
            ]

            tabSelector.forEach(function(tabSelector){
                handleAddNewCategory(tabSelector);
                handleSaveButtonClick(tabSelector);
            });

        });
    </script>
</th:block>

<div layout:fragment="content" class="container my-3">
    <h3>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h3><br>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="user-tab" data-bs-toggle="tab" data-bs-target="#user-tab-pane" type="button" role="tab" aria-controls="user-tab-pane" aria-selected="true">íšŒì› ì‹ ê³ </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="post-tab" data-bs-toggle="tab" data-bs-target="#post-tab-pane" type="button" role="tab" aria-controls="post-tab-pane" aria-selected="false">ê²Œì‹œë¬¼ ì‹ ê³ </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="faq-tab" data-bs-toggle="tab" data-bs-target="#faq-tab-pane" type="button" role="tab" aria-controls="faq-tab-pane" aria-selected="false">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="question-tab" data-bs-toggle="tab" data-bs-target="#question-tab-pane" type="button" role="tab" aria-controls="question-tab-pane" aria-selected="false">ë¬¸ì˜í•˜ê¸°</button>
        </li>
    </ul>
    <br>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="user-tab-pane" role="tabpanel" aria-labelledby="user-tab" tabindex="0">
            <div class="container surround">
                <a href="#" class="clickable-text" id="user">+ìƒˆì¹´í…Œê³ ë¦¬ ì¶”ê°€</a><br>
                <div class="tableBox">
                    <table>
                        <tr>
                            <td colspan="3"><input type="text" class="newCate form-control" id="user_newCate" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" hidden="hidden"></td>
                        </tr>
                        <tr th:each="cateList : ${cateListU}">
                            <td><input type="text" class="KindName form-control" th:value="${cateList.userClaimKindName}" th:id="'user_' + ${cateList.userClaimKindSeq}" readonly></td>
                            <td><button type="button" class="modify-button btn btn-outline-warning" th:data-id="'user_' + ${cateList.userClaimKindSeq}">âœï¸ìˆ˜ì •ï¸</button></td>
                            <td><button type="button" class="delete-button btn btn-outline-danger" th:data-id="'user_' + ${cateList.userClaimKindSeq}">ğŸ—‘ï¸ì‚­ì œ</button></td>
                        </tr>
                    </table>
                </div>
                <br>
                <div class="buttonBox">
                    <button type="button" class="save-button btn btn-primary">ì €ì¥</button>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="post-tab-pane" role="tabpanel" aria-labelledby="post-tab" tabindex="0">
            <div class="container surround">
                <a href="#" class="clickable-text" id="post">+ìƒˆì¹´í…Œê³ ë¦¬ ì¶”ê°€</a><br>
                <div class="tableBox">
                    <table>
                        <tr>
                            <td><input type="text" class="newCate form-control" id="post_newCate" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" hidden="hidden"></td>
                        </tr>
                        <tr th:each="cateList : ${cateListP}">
                            <td><input type="text" class="KindName form-control" th:value="${cateList.postClaimKindName}" th:id="'post_' + ${cateList.postClaimKindSeq}" readonly></td>
                            <td><button type="button" class="modify-button btn btn-outline-warning" th:data-id="'post_' + ${cateList.postClaimKindSeq}">âœï¸ìˆ˜ì •ï¸</button></td>
                            <td><button type="button" class="delete-button btn btn-outline-danger" th:data-id="'post_' + ${cateList.postClaimKindSeq}">ğŸ—‘ï¸ì‚­ì œ</button></td>
                        </tr>
                    </table>
                </div>
                <br>
                <div class="buttonBox">
                    <button type="button" class="save-button btn btn-primary">ì €ì¥</button>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="faq-tab-pane" role="tabpanel" aria-labelledby="faq-tab" tabindex="0">
            <div class="container surround">
                <a href="#" class="clickable-text" id="faq">+ìƒˆì¹´í…Œê³ ë¦¬ ì¶”ê°€</a><br>
                <div class="tableBox">
                    <table>
                        <tr>
                            <td><input type="text" class="newCate form-control" id="faq_newCate" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" hidden="hidden"></td>
                        </tr>
                        <tr th:each="cateList : ${cateListF}">
                            <td><input type="text" class="KindName form-control" th:value="${cateList.faqKindName}" th:id="'faq_' + ${cateList.faqKindSeq}" readonly></td>
                            <td><button type="button" class="modify-button btn btn-outline-warning" th:data-id="'faq_' + ${cateList.faqKindSeq}">âœï¸ìˆ˜ì •ï¸</button></td>
                            <td><button type="button" class="delete-button btn btn-outline-danger" th:data-id="'faq_' + ${cateList.faqKindSeq}">ğŸ—‘ï¸ì‚­ì œ</button></td>
                        </tr>
                    </table>
                </div>
                <br>
                <div class="buttonBox">
                    <button type="button" class="save-button btn btn-primary">ì €ì¥</button>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="question-tab-pane" role="tabpanel" aria-labelledby="question-tab" tabindex="0">
            <div class="container surround">
                <a href="#" class="clickable-text" id="ques">+ìƒˆì¹´í…Œê³ ë¦¬ ì¶”ê°€</a><br>
                <div class="tableBox">
                    <table>
                        <tr>
                            <td><input type="text" class="newCate form-control" id="ques_newCate" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" hidden="hidden"></td>
                        </tr>
                        <tr th:each="cateList : ${cateListQ}">
                            <td><input type="text" class="KindName form-control" th:value="${cateList.questionKindName}" th:id="'ques_' + ${cateList.questionKindSeq}" readonly></td>
                            <td><button type="button" class="modify-button btn btn-outline-warning" th:data-id="'ques_' + ${cateList.questionKindSeq}">âœï¸ìˆ˜ì •ï¸</button></td>
                            <td><button type="button" class="delete-button btn btn-outline-danger" th:data-id="'ques_' + ${cateList.questionKindSeq}">ğŸ—‘ï¸ì‚­ì œ</button></td>
                        </tr>
                    </table>
                </div>
                <br>
                <div class="buttonBox">
                    <button type="button" class="save-button btn btn-primary">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>
</div>
</html>
